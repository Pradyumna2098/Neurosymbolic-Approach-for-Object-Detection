name: Tests

on:
  pull_request:
    branches:
      - master
      - main
  push:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  test-pipeline:
    name: Test Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y swi-prolog
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-pipeline-${{ hashFiles('requirements/common.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-pipeline-
            ${{ runner.os }}-pip-
      
      - name: Install pipeline dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
          # Install PyTorch CPU-only version first to prevent conflicts
          pip install torch==2.2.2 torchvision==0.17.2 --index-url https://download.pytorch.org/whl/cpu
          # Install common dependencies (includes sahi, ultralytics) ensuring torch version is preserved
          if [ -f requirements/common.txt ]; then
            # Install packages one by one to control dependency resolution
            pip install --no-deps sahi==0.11.36
            pip install --no-deps ultralytics==8.2.77
            # Install other dependencies from common.txt
            pip install numpy==1.26.4 pandas==2.2.2 pyyaml==6.0.1
            pip install torchmetrics==1.4.0.post0
            pip install opencv-python==4.10.0.84 tqdm==4.66.4
            pip install matplotlib==3.8.4 networkx==3.3
            pip install pyswip==0.2.10
            # Install remaining dependencies for ML packages
            pip install scipy>=1.4.1 shapely>=1.8.0 seaborn>=0.11.0 psutil thop
          fi
      
      - name: Run pipeline tests
        run: |
          pytest tests/pipeline/ -v
  
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'
      
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-backend-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-backend-
            ${{ runner.os }}-pip-
      
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          # Install PyTorch CPU-only version first (required by inference service)
          pip install torch==2.2.2 torchvision==0.17.2 --index-url https://download.pytorch.org/whl/cpu
          # Install ML libraries that depend on torch, using --no-deps to prevent torch version conflicts
          pip install --no-deps sahi==0.11.36
          pip install --no-deps ultralytics==8.2.77
          # Install remaining dependencies for sahi and ultralytics
          pip install opencv-python>=4.6.0 scipy>=1.4.1 shapely>=1.8.0
          pip install PyYAML>=5.3.1 tqdm>=4.64.0 matplotlib>=3.3
          pip install pandas>=1.1.4 seaborn>=0.11.0 psutil thop
          # Install backend requirements
          pip install -r backend/requirements.txt
      
      - name: Run backend tests
        run: |
          pytest tests/backend/ -v

